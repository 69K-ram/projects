<canvas id="canvas" width=400 height=400 style="border: 1px grey solid">

  <script>

    var canvas = document.getElementById("canvas");
    var canvas_context = canvas.getContext("2d");
    var canvas_buffer = canvas_context.getImageData(0, 0, canvas.width, canvas.height);
    var canvas_pitch = canvas_buffer.width * 4;
    var PutPixel = function(x, y, color) {
      x = canvas.width/2 + x;
      y = canvas.height/2 - y - 1;
      if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) {
        return;
      }
      var offset = 4*x + canvas_pitch*y;
      canvas_buffer.data[offset++] = color[0];
      canvas_buffer.data[offset++] = color[1];
      canvas_buffer.data[offset++] = color[2];
  canvas_buffer.data[offset++] = 255; // Alpha = 255 (full opacity)
}
var UpdateCanvas = function() {
  canvas_context.putImageData(canvas_buffer, 0, 0);
}

// Converts 2D canvas coordinates to 3D viewport coordinates.
var CanvasToViewport = function(p2d) {
  return [p2d[0] / canvas.width,
  p2d[1] / canvas.height,
  projection_plane_z];
}

var distance = function(point, spheres, numberOfSpheres) {
  var dstToScene = far;
  for (var i = 0; i < numberOfSpheres; i++) {
   var a = (spheres[i][0]-point[0]) **2;
   var b = (spheres[i][1]-point[1]) **2;
   var c = (spheres[i][2]-point[2]) **2;
   dstToScene = Math.min(Math.sqrt(Math.abs(a+b+c)) - spheres[i][3], dstToScene);
 }
 return dstToScene;
} 

// canvas settings
var near = 0.05; // when ray is close enough to register a hit
var far = 1000;

// camera settings
var viewport_size = 1;
var projection_plane_z = -1;

var direction = [0,0,0];
var p = [0,0,0]; // the ray location
var distanceToScene = far;
var distanceToLight = far;

var circles = [
  [5,0,-10, 2],
  [-5,0,-10, 2],
  [0,0,-10, 2]
];

var lights = [
  [5,15,-10,5]
];

for (var x = -canvas.width/2; x < canvas.width/2; x++) {
  for (var y = -canvas.height/2; y < canvas.height/2; y++) {
    direction = CanvasToViewport([x, y]);
    //console.log(direction);
    direction[0] = direction[0]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
    direction[1] = direction[1]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
    direction[2] = direction[2]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
    distanceToScene = far-1;
    p = [0,0,0];
    while (distanceToScene < far && distanceToScene > near) {
      distanceToScene = distance(p, circles, circles.length);
      p[0] += distanceToScene * direction[0];
      p[1] += distanceToScene * direction[1];
      p[2] += distanceToScene * direction[2];
    }
    if (distanceToScene < near) {
        PutPixel(x, y, [200,200,200]);
        direction[0] = lights[0][0] - p[0];
        direction[1] = lights[0][1] - p[1];
        direction[2] = lights[0][2] - p[2];
        direction[0] = direction[0]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
        direction[1] = direction[1]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
        direction[2] = direction[2]/Math.sqrt(direction[0]**2 + direction[1]**2 + direction[2]**2);
        distanceToLight = far-1;
        distanceToScene = far-1;
        while (distanceToLight < far && distanceToLight > near) {
          distanceToLight = distance(p, lights, lights.length);
          distanceToScene = distance(p, circles, circles.length);
          p[0] += distanceToLight * direction[0];
          p[1] += distanceToLight * direction[1];
          p[2] += distanceToLight * direction[2];
          if (distanceToLight - distanceToScene < near){ 
            break; 
          }
        }
        if (distanceToLight < near) {
         //console.log(distanceToLight);
         PutPixel(x, y, [0,0,0]);
       } 
     }
   }
 }
UpdateCanvas();

</script>
